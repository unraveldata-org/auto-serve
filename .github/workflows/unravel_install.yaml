name: install-unravel

on: 
  workflow_dispatch:  
    inputs:
      server_ip:
        description: 'The IP of the server'
        required: true
        default: '172.36.25.12'
      unravel_artifact:
        description: 'The URL of the unravel tar.gz file'
        required: true
        default: 'http://cerdo.unraveldata.com:8081/artifactory/dist-internal/unravel/hotfix/4.7.9.7/unravel-4.7.9.7-hotfix.9121.tar.gz'
      unravel_directory:
        description: 'Unravel installation path'
        required: true
        default: '/opt/'

jobs:
  install_unravel:
    runs-on: [self-hosted, selfserve]
    env:
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Unravel
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ github.event.inputs.server_ip }}
          username: root
          port: 22
          password: ${{ secrets.DC_PASSWORD }}
          timeout: 60m
          command_timeout: 60m
          script: |
            filename=$(basename ${{ github.event.inputs.unravel_artifact }})
            echo "File_name: $filename"
            version=$(echo $filename | sed -n 's/unravel-\(.*\)\.tar\.gz/\1/p')
            echo "Extracted version: $version"
            sudo su unravel <<EOF
              wget ${{ github.event.inputs.unravel_artifact }} -O /tmp/$filename
              tar xvf /tmp/$filename -C ${{ github.event.inputs.unravel_directory }}
              ${{ github.event.inputs.unravel_directory }}/unravel/manager stop then activate $version --skip-precheck
              sleep 300
              ${{ github.event.inputs.unravel_directory }}/unravel/manager start
            EOF
